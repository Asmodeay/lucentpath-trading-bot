{% extends "base.html" %}

{% block content %}
<div class="px-4 py-6" x-data="dashboardData()">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900">Trading Dashboard</h1>
        <p class="text-gray-600">Welcome back, {{ user.username }}!</p>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- Total Trades -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-blue-100 rounded-md">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total Trades</p>
                    <p class="text-2xl font-semibold text-gray-900" x-text="totalTrades">0</p>
                </div>
            </div>
        </div>

        <!-- Total P&L -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-green-100 rounded-md">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total P&L</p>
                    <p class="text-2xl font-semibold" :class="totalPnl >= 0 ? 'text-green-600' : 'text-red-600'" x-text="'$' + totalPnl.toFixed(2)">$0.00</p>
                </div>
            </div>
        </div>

        <!-- Bot Status -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 rounded-md" :class="botRunning ? 'bg-green-100' : 'bg-red-100'">
                    <svg class="w-6 h-6" :class="botRunning ? 'text-green-600' : 'text-red-600'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Bot Status</p>
                    <p class="text-2xl font-semibold" :class="botRunning ? 'text-green-600' : 'text-red-600'" x-text="botRunning ? 'Running' : 'Stopped'">Stopped</p>
                </div>
            </div>
        </div>

        <!-- Subscription Plan -->
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-2 bg-purple-100 rounded-md">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Plan</p>
                    <p class="text-2xl font-semibold text-gray-900">{{ user.subscription_tier.title() }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot Controls -->
    <div class="bg-white rounded-lg shadow mb-8">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Bot Controls</h3>
        </div>
        <div class="p-6">
            <!-- Status Information -->
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">
                    Current Status: 
                    <span class="font-medium" :class="botRunning ? 'text-green-600' : 'text-red-600'" x-text="botRunning ? 'Running' : 'Stopped'">Stopped</span>
                </p>
                
                <!-- Warning Messages -->
                <div x-show="!subscriptionActive" class="text-sm text-red-600 mb-2">
                    ⚠️ Active subscription required to run bot
                </div>
                <div x-show="!hasApiKeys" class="text-sm text-orange-600 mb-2">
                    ⚠️ Add API keys in Settings to enable trading
                </div>
                <div x-show="!hasConfig" class="text-sm text-orange-600 mb-2">
                    ⚠️ Configure trading strategies in Settings
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="flex items-center justify-between">
                <div></div> <!-- Spacer -->
                <div class="flex space-x-4">
                    <!-- Start Bot Button -->
                    <button 
                        @click="startBot()" 
                        :disabled="!canStart || loading" 
                        class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span x-show="!(loading && action === 'start')">Start Bot</span>
                        <span x-show="loading && action === 'start'">Starting...</span>
                    </button>
                    
                    <!-- Stop Bot Button -->
                    <button 
                        @click="stopBot()" 
                        :disabled="!botRunning || loading" 
                        class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span x-show="!(loading && action === 'stop')">Stop Bot</span>
                        <span x-show="loading && action === 'stop'">Stopping...</span>
                    </button>
                </div>
            </div>
            
            <!-- Status Messages -->
            <div x-show="message" class="mt-4 p-3 rounded-md" :class="messageType === 'success' ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'" x-text="message"></div>
        </div>
    </div>

    <!-- Recent Trades Table -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Recent Trades</h3>
        </div>
        
        <!-- Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Side</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Strategy</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P&L</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="trade in trades" :key="trade.id">
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="trade.symbol"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span 
                                    class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" 
                                    :class="trade.side === 'buy' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" 
                                    x-text="trade.side.toUpperCase()">
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="trade.amount.toFixed(6)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="'$' + trade.price.toFixed(2)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="trade.strategy"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm" 
                                :class="trade.pnl >= 0 ? 'text-green-600' : 'text-red-600'" 
                                x-text="'$' + trade.pnl.toFixed(2)"></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="formatDate(trade.executed_at)"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
            
            <!-- Empty State -->
            <div x-show="trades.length === 0" class="px-6 py-12 text-center">
                <p class="text-gray-500 mb-2">No trades yet. Configure your bot and start trading!</p>
                <a href="{{ url_for('settings') }}" class="text-blue-600 hover:text-blue-500 inline-block">Go to Settings →</a>
            </div>
        </div>
    </div>
</div>

<script>
function dashboardData() {
    return {
        // Simple data properties
        botRunning: false,
        subscriptionActive: {{ 'true' if user.is_subscription_active() else 'false' }},
        loading: false,
        action: '',
        message: '',
        messageType: '',
        hasApiKeys: false,
        hasConfig: false,
        totalTrades: 0,
        totalPnl: 0.0,
        trades: [],
        
        // Computed property
        get canStart() {
            return this.subscriptionActive && this.hasApiKeys && this.hasConfig && !this.botRunning;
        },
        
        // Methods
        async startBot() {
            this.loading = true;
            this.action = 'start';
            this.message = '';
            
            try {
                const response = await fetch('/bot/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.botRunning = true;
                    this.showMessage('Bot started successfully!', 'success');
                } else {
                    this.showMessage(data.error || 'Failed to start bot', 'error');
                }
            } catch (err) {
                this.showMessage('Network error. Please try again.', 'error');
            } finally {
                this.loading = false;
                this.action = '';
            }
        },
        
        async stopBot() {
            this.loading = true;
            this.action = 'stop';
            this.message = '';
            
            try {
                const response = await fetch('/bot/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.botRunning = false;
                    this.showMessage('Bot stopped successfully!', 'success');
                } else {
                    this.showMessage(data.error || 'Failed to stop bot', 'error');
                }
            } catch (err) {
                this.showMessage('Network error. Please try again.', 'error');
            } finally {
                this.loading = false;
                this.action = '';
            }
        },
        
        async loadData() {
            try {
                // Load bot status
                const statusRes = await fetch('/bot/status');
                if (statusRes.ok) {
                    const status = await statusRes.json();
                    this.botRunning = status.running || false;
                }
                
                // Load trades
                const tradesRes = await fetch('/api/trades');
                if (tradesRes.ok) {
                    const tradesData = await tradesRes.json();
                    this.trades = tradesData.trades || [];
                    this.totalTrades = tradesData.total || 0;
                    this.totalPnl = this.trades.reduce((sum, trade) => sum + (trade.pnl || 0), 0);
                }
                
                // Check API keys
                const apiRes = await fetch('/api/api-keys');
                if (apiRes.ok) {
                    const apiKeys = await apiRes.json();
                    this.hasApiKeys = apiKeys.length > 0;
                }
                
                // Check config
                const configRes = await fetch('/api/bot-config');
                if (configRes.ok) {
                    const configs = await configRes.json();
                    this.hasConfig = configs.length > 0;
                }
                
            } catch (err) {
                console.error('Failed to load data:', err);
            }
        },
        
        showMessage(msg, type) {
            this.message = msg;
            this.messageType = type;
            setTimeout(() => {
                this.message = '';
            }, 5000);
        },
        
        formatDate(dateString) {
            try {
                return new Date(dateString).toLocaleString();
            } catch {
                return dateString || '';
            }
        },
        
        // Initialize
        init() {
            this.loadData();
            setInterval(() => this.loadData(), 10000);
        }
    }
}
</script>
{% endblock %}